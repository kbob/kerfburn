#!/usr/bin/make -*- makefile-gmake -*-
# This file is included by the toplevel makefile.

   fw_sources := main.c abort.c fw_assert.c param.c parser.c serial.c softint.c timer.c

     BACK_MCU := atmega2560
      BACK_CC := avr-gcc
      BACK_AR := avr-ar
      BACK_LD := avr-gcc
 BACK_OBJCOPY := avr-objcopy
 BACK_AVRDUDE := avrdude

BACK_CPPFLAGS := -mmcu=$(BACK_MCU) -DF_CPU=16000000L
  BACK_CFLAGS := -g -O3 -std=c99 -Wall -Werror
 BACK_LDFLAGS := -Wl,--gc-sections,--relax -mmcu=$(BACK_MCU)

    fw_cfiles := $(filter %.c, $(fw_sources:%=back/%))
    fw_ofiles := $(fw_cfiles:%.c=%.o)

all-back:   build-back
build-back: back-programs
load-back:  back/fw.hex
	$(BACK_AVRDUDE) -qq -p$(BACK_MCU) -D -Uflash:w:$<

clean-back:
	cd back && rm -f fw *~ *.o .*.d TAGS $(JUNK)

back-programs: back/fw

back/fw: $(fw_ofiles)
	$(BACK_LD) $(BACK_LDFLAGS) $^ $(fw_ldlibs) -o $@

back/%.o: back/%.c
	$(BACK_CC) $(BACK_CFLAGS) $(BACK_CPPFLAGS) -c $< -o $@

back/%.hex: back/%
	$(BACK_OBJCOPY) -O ihex -R .eeprom $< $@

# C source dependency generation.
back/.%.d : back/%.c
	@rm -f "$@"
	@$(BACK_CC) -M -MP -MT 'back/$*.o $@' -MF $@ $(BACK_CPPFLAGS) $< || \
	    rm -f "$@"

.PHONY: all-back build-back load-back clean-back back-programs
JUNK += *.hex

ifeq '$(filter clean% help,$(or $(MAKECMDGOALS),help))' ''
  -include $(fw_cfiles:back/%.c=back/.%.d)
endif
